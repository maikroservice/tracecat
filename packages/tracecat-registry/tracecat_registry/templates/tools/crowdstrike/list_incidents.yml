type: action
definition:
  name: list_incidents
  namespace: tools.crowdstrike
  title: List incidents
  description: Query for Crowdstrike incidents via the Falcon SIEM API.
  display_group: CrowdStrike
  doc_url: https://falconpy.io/Service-Collections/Incidents.html
  author: null
  deprecated: null
  secrets: null
  expects:
    limit:
      type: int
      description: Maximum number of incidents to return.
      default: 100
    query:
      type: str| None
      description: >
        Falcon Query Language (FQL) filter to apply to cases. If specified,
        overrides `start_time` and `end_time`.
      default: null
    start_time:
      type: str | None
      description: Start time for the query (inclusive). ISO 8601 format (e.g.,
        '2024-01-01T00:00:00Z').
      default: null
    end_time:
      type: str | None
      description: End time for the query (exclusive). ISO 8601 format (e.g.,
        '2024-01-31T23:59:59Z') - defaults to now.
      default: null
    member_cid:
      type: str | None
      description: Crowdstrike member CID.
      default: null
  steps:
    - ref: build_filter
      action: core.script.run_python
      args:
        inputs:
          query: ${{ inputs.query }}
          start_time: ${{ inputs.start_time }}
          end_time: ${{ inputs.end_time }}
        script: >
          from datetime import datetime

          def main(query, start_time, end_time):
              if query:
                  return query

              if not start_time or not end_time:
                  raise ValueError("start_time and end_time are required when query is not provided")
              
              if not end_time:
                  end_time = datetime.now(timezone.utc).isoformat()

              # Strip any extra quotes that might be present from the nextjs inputs
              start_time_strip = start_time.strip('"').strip("'")
              end_time_strip = end_time.strip('"').strip("'")

              start_dt = datetime.fromisoformat(start_time_strip.replace('Z', '+00:00'))
              end_dt = datetime.fromisoformat(end_time_strip.replace('Z', '+00:00'))

              return f"created_date:>='{start_dt.isoformat()}' + created_date:<'{end_dt.isoformat()}'"
    - ref: query_incidents
      action: tools.falconpy.call_command
      args:
        member_cid: ${{ inputs.member_cid }}
        operation_id: QueryIncidents
        params:
          limit: ${{ inputs.limit }}
          filter: ${{ steps.build_filter.result }}
    - ref: get_incidents
      action: tools.falconpy.call_command
      args:
        member_cid: ${{ inputs.member_cid }}
        operation_id: GetIncidents
        params:
          body:
            ids: ${{ steps.query_incidents.result.body.resources }}
  returns: ${{ steps.get_incidents.result.data }}

